<ul class="breadcrumb">
  <li>
    <a href="/"><i class="icon-home"></i> Dashboard</a> <span class="divider">/</span>
  </li>
  <li>
    <a href="/purchase_orders"><i class="icon-folder-open"></i> Versand</a> <span class="divider">/</span>
  </li>
  <li class="active">
    <a href="/cargo_lists/<%= @cargo_list.id %>"><%= @cargo_list.id %></a>
  </li>
</ul>

<div class="page-header">
  <h1>Versand NR#<%= @cargo_list.id %> <small><%= @cargo_list.pick_up_time_earliest.to_date.to_formatted_s(:swiss_date) %> / <%= @cargo_list.country %></small></h1>
</div>

<div class="btn-toolbar">
  <% if permitted_to? :edit, :cargo_lists %>
    <div class="btn-group">
      <a class="btn" href="<%= edit_cargo_list_path(@cargo_list) %>"><i class="icon-edit"></i> Edit</a>
    </div>
  <% end %>
  <% if @assigned_pallets.present? %>
    <div class="btn-group">
      <a class="btn" href="<%= cargo_list_path(@cargo_list, :format => :pdf, :pdf_type => 'report_lebert') %>"><i class="icon-print"></i> Transport Anmeldung</a>
      <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
        <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
        <li><a href="<%= cargo_list_path(@cargo_list, :format => :pdf, :pdf_type => "report") %>"><i class="icon-print"></i> Rüstschein</a></li>
      </ul>
    </div>
    <% unless @cargo_list.country == 'CH' %>
      <div class="btn-group">
        <a class="btn" href="<%= cargo_list_path(@cargo_list, :format => :pdf, :pdf_type => "invoice") %>"><i class="icon-print"></i> Zollpapiere</a>
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
          <li><a href="<%= cargo_list_path(@cargo_list, :format => :pdf, :pdf_type => "report_controll") %>"><i class="icon-print"></i> Kontrolle</a></li>
        </ul>
      </div>
    <% else %>
      <div class="btn-group">
        <a class="btn" href="<%= cargo_list_path(@cargo_list, :format => :pdf, :pdf_type => "delivery_receipt") %>"><i class="icon-print"></i> Lieferschein</a>
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
          <li><a href="<%= cargo_list_path(@cargo_list, :format => :pdf, :pdf_type => "pick_up_receipt") %>"><i class="icon-print"></i> Abholschein</a></li>
        </ul>
      </div>
    <% end %>
  <% end %>
</div>

<% if @cargo_list.delivered == true %>
  <div id="flash_notice">Versand NR<%= @cargo_list.id %> wurde bereits versendet. Klicke <%= link_to("hier", cargo_lists_path()) %> um zurückzukehren.</div>
<% end %>

<% if @assigned_pallets.present? %>
  
  <blockquote>
    <p>Empfänger: <%= @cargo_list.referee %></p>
    <p><%= @pallets_count.to_i %> Paletten / <%= @cargo_list.additional_space %> Mehrplatz</p>
  </blockquote>
  
  <section class="filter_box">
    <h3>Angefügte Paletten / Coli</h3>
    <section class="filter_box_content clearfix">
      <%= form_tag(remove_pallets_cargo_lists_path, {:class => "form", "data-submit_handler" => "true", :method => :post}) do %>
        <%= hidden_field_tag("cargo_id", @cargo_list.id) %>
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>NR</th>
              <th>Pos</th>
              <th>Mehrplatz</th>
              <th>Tour</th>
              <th>PLZ Gebiet</th>
              <th>Empfänger</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @assigned_pallets.each do |pallet| %>
              <tr>
                <td class="<%= pallet.mixed? ? "mixed" : "not_mixed" %>"><%= pallet.pallet_type.description == "coli" ? link_to("Coli #{pallet.id}", ajax_show_pallet_path(pallet), "data-role" => "table_remote") : link_to("Palette #{pallet.id}", ajax_show_pallet_path(pallet), "data-role" => "table_remote") %></td>
                <td><%= pallet.purchase_positions.count %></td>
                <td><%= pallet.additional_space %></td>
                <td><%= pallet.purchase_orders.where("shipping_route_id IS NOT NULL").present? ? pallet.purchase_orders.where("shipping_route_id IS NOT NULL").first.shipping_route.name : nil %></td>
                <td><%= pallet.purchase_positions.where("purchase_positions.zip_location_id IS NOT NULL").present? ? pallet.purchase_positions.where("purchase_positions.zip_location_id IS NOT NULL").first.zip_location_name : nil %></td>
                <td><%= pallet.purchase_positions.where("consignee_full IS NOT NULL").present? ? pallet.purchase_positions.where("consignee_full IS NOT NULL").first.consignee_full : nil %></td>
                <% if permitted_to? :remove_pallets, :cargo_lists %>
                  <td style="text-align:center;"><%= check_box_tag "pallet_ids[]", pallet.id %></td>
                <% else %>
                  <td></td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <% if permitted_to? :remove_pallets, :cargo_lists %>
              <tr>
                <% 6.times do %>
                  <td></td>
                <% end %>
                <td style="text-align:center;"><%= submit_tag "Entfernen", :name => "submit", :class => "btn btn-small btn-danger", :disabled => false, :disable_with => "Entferne..." %></td>
              </tr>
            <% end %>
          </tfoot>
        </table>
      <% end %>
    </section>
  </section>
  
<% else %>
  <div id="flash_notice">Es sind noch keine Paletten zugewiesen worden.</div>
<% end %>

<hr />

<% if @pallets.present? %>
  <section class="filter_box">
    <h3>Verfügbare Paletten / Coli</h3>
    <section class="filter_box_content clearfix">
      <%= form_tag(assign_pallets_cargo_lists_path, {:class => "form", "data-submit_handler" => "true", :method => :post}) do %>
        <%= hidden_field_tag("cargo_id", @cargo_list.id) %>
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>NR</th>
              <th>Pos</th>
              <th>Mehrplatz</th>
              <th>Tour</th>
              <th>PLZ Gebiet</th>
              <th>Empfänger</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @pallets.each do |pallet| %>
              <% if pallet.purchase_positions.present? %>
                <tr>
                  <td class="<%= pallet.mixed? ? "mixed" : "not_mixed" %>">
                    <%= pallet.pallet_type.description == "coli" ? link_to("Coli #{pallet.id}", ajax_show_pallet_path(pallet), "data-role" => "table_remote") : link_to("Palette #{pallet.id}", ajax_show_pallet_path(pallet), "data-role" => "table_remote") %>
                  </td>
                  <td><%= pallet.purchase_positions.count %></td>
                  <td><%= pallet.additional_space %></td>
                  <td><%= pallet.purchase_orders.first.shipping_route.present? ? pallet.purchase_orders.first.shipping_route.name : nil %></td>
                  <td><%= pallet.purchase_positions.where("purchase_positions.zip_location_id IS NOT NULL").present? ? pallet.purchase_positions.where("purchase_positions.zip_location_id IS NOT NULL").first.zip_location_name : nil %></td>
                  <td><%= pallet.purchase_positions.first.consignee_full.present? ? pallet.purchase_positions.first.consignee_full : pallet.purchase_orders.first.customer.company %></td>
                  <% if permitted_to? :assign_pallets, :cargo_lists %>
                    <td style="text-align:center;"><%= check_box_tag "pallet_ids[]", pallet.id %></td>
                  <% else %>
                    <td></td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <% if permitted_to? :assign_pallets, :cargo_lists %>
              <tr>
                <% 6.times do %>
                  <td></td>
                <% end %>
                <td style="text-align:center;"><%= submit_tag "Hinzufügen", :name => "submit", :class => "btn btn-small btn-primary", :disabled => false, :disable_with => "Füge hinzu..." %></td>
              </tr>
            <% end %>
          </tfoot>
        </table>
      <% end %>
    </section>
  </section>
  
<% else %>
  <div id="flash_notice">Es wurden bereits alle Palleten bearbeitet!</div>
<% end %>
