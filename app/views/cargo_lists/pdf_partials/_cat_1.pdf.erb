<header id="invoice_header" class="clearfix">
  <%= wicked_pdf_image_tag 'logo.gif', :class => "floatLeft" %>
  <ul class="floatLeft">
    <li class="bold">Verkaufsinnendienst</li>
    <li>Telefon +41 71 982 80 84</li>
    <li>Telefax +41 71 982 80 77</li>
  </ul>

  <ul class="floatLeft">
    <li class="bold">Fraefel AG</li>
    <li>Lerchenfeld</li>
    <li>CH-9601 Lütisburg-Station</li>
    <li>www.fraefel.ag</li>
  </ul>
</header>

<h1 class="logo_title">Sammelrechnung - Detail</h1>
<section class="clearfix">
  <h1 class="floatLeft">Diverse Empfänger in Deutschland</h1>
</section>
<hr>

<section id="customer_attributes_1" class="clearfix">
  <ul id="column_1" class="floatLeft">
    <li>DE-ST-Nr.</li>
    <li>DE-Zollnummer Fraefel</li>
  </ul>
  <ul id="column_2" class="floatLeft">
    <li class="bold">DE 09408/24772</li>
    <li class="bold">6207308</li>
  </ul>
  <ul id="column_3" class="floatLeft">
    <li>U/Z</li>
    <li>&nbsp;</li>
  </ul>
  <ul id="column_4" class="floatLeft">
    <li><%= current_user.username %></li>
    <li>&nbsp;</li>
  </ul>
  <ul id="column_5" class="floatLeft">
    <li class="white_color">.</li>
    <li class="white_color">.</li>
  </ul>
</section>

<section id="customer_attributes_2" class="clearfix">
  <ul id="column_1" class="floatLeft">
    <li>Versand Nr.</li>
    <li>Transport/Lieferung</li>
  </ul>
  <ul id="column_2" class="floatLeft">
    <li class="bold"><%= @cargo_list.id %></li>
    <li class="bold"><%= @cargo_list.pick_up_time_earliest.to_date.to_formatted_s(:swiss_date) %></li>
  </ul>
  <ul id="column_3" class="floatLeft">
    <li class="white_color">.</li>
    <li class="white_color">.</li>
  </ul>
  <ul id="column_4" class="floatLeft">
    <li class="white_color">.</li>
    <li class="bold">&nbsp;</li>
  </ul>
</section>

<section id="price_table">
  <table>
    <thead>
      <tr>
        <th>Eori NR.</th>
        <th>Warenempfänger</th>
        <th></th>
        <th class="align-right" style="white-space:nowrap;">Brutto</th>
        <th class="align-right" style="white-space:nowrap;">Rabatt</th>
        <th class="align-right" style="white-space:nowrap;">Warenwert</th>
      </tr>
    </thead>
    <tbody>
      <% @purchase_positions.group("purchase_positions.level_3").count.each do |k, v| %>
      <tr>
        <td style="white-space:nowrap;">eori-fault</td>
        <td><%= Address.find(k).consignee_full %></td>
        <td class="align-right">EUR</td>
        <td class="align-right" style="white-space:nowrap;">
          <%= PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id).where("purchase_positions.level_3 = ?", k).includes([:pallet => [:cargo_list]], :purchase_position).sum(:gross_price) %>
        </td>
        <td class="align-right" style="white-space:nowrap;">
          <%= PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id).where("purchase_positions.level_3 = ?", k).includes([:pallet => [:cargo_list]], :purchase_position).sum(:value_discount) %>
        </td>
        <td class="align-right" style="white-space:nowrap;">
          <%= PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id).where("purchase_positions.level_3 = ?", k).includes([:pallet => [:cargo_list]], :purchase_position).sum(:net_price) %>
        </td>
      </tr>
      <% end %>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td style="white-space:nowrap;">Zwischentotal</td>
        <td></td>
        <td></td>
        <td class="align-right" style="white-space:nowrap;">
          <%= PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id ).includes(:pallet => :cargo_list).sum(:net_price) %>
        </td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td style="white-space:nowrap;">MwSt 19.00%</td>
        <td></td>
        <td></td>
        <td class="align-right" style="white-space:nowrap;">
          <%= ((PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id ).includes(:pallet => :cargo_list).sum(:net_price) / 100) * 19).round(2) %>
        </td>
      </tr>
      <tr>
        <td class="bold"></td>
        <td class="bold"></td>
        <td class="bold" style="white-space:nowrap;">Rechnungswert Euro</td>
        <td></td>
        <td></td>
        <td class="align-right bold" style="white-space:nowrap;">
          <%= ((PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id ).includes(:pallet => :cargo_list).sum(:net_price) / 100) * 19).round(2) + PalletPurchasePositionAssignment.where("cargo_lists.id = ?", @cargo_list.id ).includes(:pallet => :cargo_list).sum(:net_price) %>
        </td>
      </tr>
    </tbody>
  </table>
</section>