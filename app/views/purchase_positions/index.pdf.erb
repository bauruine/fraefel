<section class="filter_box">
  <header class="filter_box_header">
    <h4 class="floatLeft">Spediliste Aktive Filter</h4>
  </header>
  <section class="filter_box_content clearfix">
    <table>
      <thead>
        <tr>
          <th>Von</th>
          <th>Bis</th>
          <th>Tour</th>
          <th>Versandlager</th>
          <th>VK-Art</th>
          <th><%= "Eingelagert >= ?%" %></th>
          <th><%= "Eingelagert <= ?%" %></th>
          <th><%= "Produziert >= ?%" %></th>
          <th><%= "Produziert <= ?%" %></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><%= params[:search][:delivery_date_greater_than_or_equal_to] if params[:search].present? %></td>
          <td><%= params[:search][:delivery_date_less_than_or_equal_to] if params[:search].present? %></td>
          <td><%= params[:search].present? && params[:search][:shipping_route_id_equals].present? ? ShippingRoute.where(:id => params[:search][:shipping_route_id_equals]).first.name : nil %></td>
          <td><%= params[:search][:warehouse_number_equals] if params[:search].present? %></td>
          <td><%= params[:search].present? && params[:search][:category_id_equals].present? ? Category.where(:id => params[:search][:category_id_equals]).first.title : nil %></td>
          <td><%= params[:search].present? ? params[:search][:warehousing_completed_gteq] : nil %></td>
          <td><%= params[:search].present? ? params[:search][:warehousing_completed_lteq] : nil %></td>
          <td><%= params[:search][:manufacturing_completed_gteq] if params[:search].present? %></td>
          <td><%= params[:search][:manufacturing_completed_lteq] if params[:search].present? %></td>
        </tr>
      </tbody>
    </table>
  </section>
</section>

<blockquote>
  <p>
    &#x2605; VK-Pos mit aktiver Terminverschiebung
  </p>
  <p>
    &#x26a0; Verschobene VK-Pos
  </p>
</blockquote>


<% Address.where(:category_id => 10).where("purchase_positions.id" => @purchase_positions.collect(&:id)).includes(:purchase_orders => :purchase_positions).order("purchase_orders.delivery_date ASC").each do |ordered_address| %>
  <section class="filter_box">
    <header class="filter_box_header">
      <h4 class="floatLeft"><%= ordered_address.location_for_select %></h4>
    </header>
    <section class="filter_box_content clearfix">
      <table>
        <thead>
          <tr>
            <th>Versand</th>
            <th>Tour</th>
            <th>VK-Pos</th>
            <th>Artikel</th>
            <th>stk.</th>
            <th>Bezeichnung</th>
            <th>Produktlinie</th>
            <th>Lager Ort</th>
            <th>Palette</th>
          </tr>
        </thead>
        <tbody>
          <% PurchaseOrder.includes(:shipping_route, :purchase_positions => [:pallets]).order("purchase_orders.delivery_date ASC").where("purchase_positions.id" => @purchase_positions.collect(&:id)).where(:level_3 => ordered_address.id).each do |purchase_order| %>
            <% purchase_order.purchase_positions.search(params[:search] || {:delivered_equals => "false"}).each do |p_o_p| %>
              <tr>
                <td id="column_1"><%= p_o_p.delivery_date.to_date.to_formatted_s(:swiss_date) %></td>
                <td id="column_2"><%= purchase_order.shipping_route.name %></td>
                <td id="column_3">
                  <% if p_o_p.priority_level == 0 %>
                    &#x2605;
                  <% elsif p_o_p.priority_level > 1 %>
                    &#x26a0;
                  <% end %>
                  <%= "#{purchase_order.baan_id}-#{p_o_p.position}" %>
                </td>
                <td id="column_4"><%= p_o_p.article_number %></td>
                <td id="column_5"><%= p_o_p.quantity %></td>
                <td id="column_6"><%= p_o_p.article %></td>
                <td id="column_7"><%= p_o_p.product_line %></td>
                <td id="column_8"><%= p_o_p.storage_location %></td>
                <td id="column_9"><%= p_o_p.pallets.collect(&:id).join(", ") %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </section>
  </section>
<% end %>

<script type="text/javascript" charset="utf-8">
  var column_1 = 0;
  var column_2 = 0;
  var column_3 = 0;
  var column_4 = 0;
  var column_5 = 0;
  var column_6 = 0;
  var column_7 = 0;
  var column_8 = 0;
  var column_9 = 0;
  
  $('td#column_1').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_1) {column_1 = this_width};
  });
  $('td#column_2').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_2) {column_2 = this_width};
  });
  $('td#column_3').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_3) {column_3 = this_width};
  });
  $('td#column_4').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_4) {column_4 = this_width};
  });
  $('td#column_5').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_5) {column_5 = this_width};
  });
  $('td#column_6').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_6) {column_6 = this_width};
  });
  $('td#column_7').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_7) {column_7 = this_width};
  });
  $('td#column_8').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_8) {column_8 = this_width};
  });
  $('td#column_9').each(function(){
          var this_width = $(this).outerWidth();
          if (this_width > column_9) {column_9 = this_width};
  });
  
  $('td#column_1').css('width', column_1 + 'px');
  $('td#column_2').css('width', column_2 + 'px');
  $('td#column_3').css('width', column_3 + 'px');
  $('td#column_4').css('width', column_4 + 'px');
  $('td#column_5').css('width', column_5 + 'px');
  $('td#column_6').css('width', column_6 + 'px');
  $('td#column_7').css('width', column_7 + 'px');
  $('td#column_8').css('width', column_8 + 'px');
  $('td#column_9').css('width', column_9 + 'px');
</script>